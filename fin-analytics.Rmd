---
title: "fin-analytics"
author: "AP"
date: "Juni 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr) # Data wrangling
library(stringr) # Flexible string ops (wildcard filtering)
```

### Read the input csv dataset - all Acc files are with detail infos
```{r}
getwd()
# Read Acc files, use ANSI encoding
d.file17 <- read.csv("input/Acc_2017.csv", sep=";", head=TRUE, stringsAsFactors=FALSE, encoding = "ANSI")
d.file18 <- read.csv("input/Acc_2018.csv", sep=";", head=TRUE, stringsAsFactors=FALSE, encoding = "ANSI")
d.file19part <- read.csv("input/Acc_2019_07.csv", sep=";", head=TRUE, stringsAsFactors=FALSE, encoding = "ANSI")

head(d.file17)
dim(d.file17)
d.file17
```

### Clean and sort data
```{r}
getwd()

# Deselect Valuta.Date, rename columns, format bookdate as date
d.file17 <- dplyr::select(d.file17, -Valuta.Date)
d.file17 <- dplyr::rename(d.file17, acc=IBAN, bookdate=Booked.At, text=Text, amount=Credit.Debit.Amount, balance=Balance)
# TODO: Format as date
#d.file17$bookdate <- as.Date(d.file17$bookdate, format="%Y-%m-%d hh:mm:ss")

# Descr file
str(d.file17)

# Filter only valid bookings
d.file17v <- d.file17 %>%
  filter(str_detect(acc, "CH9180"))

# Filter non-valid bookings
d.file17nv <- d.file17 %>% 
  filter(!str_detect(acc, "CH9180"))


```

### Categorize data
```{r}
# Add a "type" column to the datafile
d.file17v$type <- "other"

# TODO: Add keywords, search them in text, update type (category)
d.file17v

# a. Keywords
cash <- "Bancomat"
shop <- "Einkauf"
ebanking <- "E-Banking"
creditcard <- "CARD"
plus <- "Gutschrift"

# b. Search and c. update
# TEST
d.file17v %>%
  select(text, type) %>%
  filter(stringr::str_detect(text, cash)) %>%
  mutate(type="Cash")

# TEST with case when, assign other to unknown, show all other
d.file17v %>%
  mutate(type = case_when(
    stringr::str_detect(text, cash) ~ "Cash",
    stringr::str_detect(text, shop) ~ "Shop",
    stringr::str_detect(text, ebanking) ~ "E-Banking",
    stringr::str_detect(text, creditcard) ~ "CreditCard",
    stringr::str_detect(text, plus) ~ "Plus",
    TRUE ~ "Other")) %>%
  filter(stringr::str_detect(type, "Other"))


```







